<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">
    <!-- Criação da tabela SETTINGS baseada em BaseEntity + Setting -->
    <changeSet id="001-create-settings" author="voloide">
        <!-- Se já existir, não recria -->
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="settings"/>
            </not>
        </preConditions>

        <!-- Para MySQL/MariaDB: engine + charset -->
        <createTable tableName="settings" >

            <!-- BaseEntity -->
            <column name="ID" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_settings"/>
            </column>

            <column name="UUID" type="VARCHAR(50)">
                <constraints nullable="false" unique="true" uniqueConstraintName="uk_settings_uuid"/>
            </column>

            <column name="CREATED_BY" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>

            <column name="CREATED_AT" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>

            <column name="UPDATED_BY" type="VARCHAR(50)"/>

            <column name="UPDATED_AT" type="TIMESTAMP"/>

            <column name="LIFE_CYCLE_STATUS" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>

            <!-- Campos específicos de Setting -->
            <column name="DESIGNATION" type="VARCHAR(150)">
                <constraints nullable="false"/>
            </column>

            <!-- ACEITA TEXTOS MUITO LONGOS -->
            <column name="SETTING_VALUE" type="LONGTEXT">
                <constraints nullable="false"/>
            </column>

            <column name="SETTING_TYPE" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>

            <column name="ENABLED" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>

            <!-- descrição pode ser grande; TEXT é suficiente -->
            <column name="DESCRIPTION" type="TEXT">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Unicidade por DESIGNATION (cada chave de configuração é única) -->
        <addUniqueConstraint tableName="settings"
                             columnNames="DESIGNATION"
                             constraintName="uk_settings_designation"/>

        <!-- Índices úteis -->
        <createIndex tableName="settings" indexName="idx_settings_designation">
            <column name="DESIGNATION"/>
        </createIndex>

        <createIndex tableName="settings" indexName="idx_settings_enabled">
            <column name="ENABLED"/>
        </createIndex>

        <createIndex tableName="settings" indexName="idx_settings_created_at">
            <column name="CREATED_AT"/>
        </createIndex>
    </changeSet>

    <changeSet id="2-create-pedidos" author="Joao Nuno Mabjaia">
        <createTable tableName="pedidos">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="pedido_id_ct" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="facility_code" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="payload" type="LONGTEXT">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="processed_at" type="DATETIME"/>
            <column name="error_msg" type="TEXT"/>
            <column name="created_by" type="varchar(50)">
                <constraints nullable="false"/>
            </column>

            <column name="created_at" type="timestamp">
                <constraints nullable="false"/>
            </column>

            <column name="updated_by" type="varchar(50)"/>

            <column name="updated_at" type="timestamp"/>

            <column name="life_cycle_status" type="varchar(100)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <!-- Tabela respostas -->
    <changeSet id="3-create-respostas" author="Joao Nuno Mabjaia">
        <createTable tableName="respostas">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="resposta_id_ct" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="pedido_id_ct" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="facility_code" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="payload" type="LONGTEXT">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="processed_at" type="DATETIME"/>
            <column name="error_msg" type="TEXT"/>
            <column name="created_by" type="varchar(50)">
                <constraints nullable="false"/>
            </column>

            <column name="created_at" type="timestamp">
                <constraints nullable="false"/>
            </column>

            <column name="updated_by" type="varchar(50)"/>

            <column name="updated_at" type="timestamp"/>

            <column name="life_cycle_status" type="varchar(100)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet id="2025-09-05-01-pedidos-pedido-id-to-bigint" author="voloide">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="pedidos"/>
            <columnExists tableName="pedidos" columnName="pedido_id_ct"/>
        </preConditions>
        <modifyDataType tableName="pedidos"
                        columnName="pedido_id_ct"
                        newDataType="BIGINT"/>
    </changeSet>

    <!-- UNIQUE em pedidos.pedido_id_ct -->
    <changeSet id="2025-09-05-02-pedidos-uk-pedido-id-ct" author="voloide">
        <addUniqueConstraint tableName="pedidos"
                             columnNames="pedido_id_ct"
                             constraintName="uk_pedidos_pedido_id_ct"/>
    </changeSet>

    <!-- respostas.resposta_id_ct e respostas.pedido_id_ct -> BIGINT -->
    <changeSet id="2025-09-05-03-respostas-ids-to-bigint" author="voloide">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="respostas"/>
        </preConditions>

        <modifyDataType tableName="respostas"
                        columnName="resposta_id_ct"
                        newDataType="BIGINT"/>

        <modifyDataType tableName="respostas"
                        columnName="pedido_id_ct"
                        newDataType="BIGINT"/>
    </changeSet>

    <!-- UNIQUE em respostas.resposta_id_ct e índice por pedido_id_ct -->
    <changeSet id="2025-09-05-04-respostas-constraints-index" author="voloide">
        <addUniqueConstraint tableName="respostas"
                             columnNames="resposta_id_ct"
                             constraintName="uk_respostas_resposta_id_ct"/>

        <createIndex tableName="respostas"
                     indexName="idx_respostas_pedido_id_ct">
            <column name="pedido_id_ct"/>
        </createIndex>
    </changeSet>

    <changeSet id="2025-09-05-uuid-01-add-col-pedidos" author="voloide">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="pedidos"/>
        </preConditions>
        <!-- VARCHAR(36) to hold UUID string -->
        <addColumn tableName="pedidos">
            <column name="uuid" type="VARCHAR(36)"/>
        </addColumn>
    </changeSet>

    <changeSet id="2025-09-05-uuid-03-constraints-pedidos" author="voloide">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="pedidos" columnName="uuid"/>
        </preConditions>
        <addNotNullConstraint tableName="pedidos"
                              columnName="uuid"
                              columnDataType="VARCHAR(36)"/>
        <addUniqueConstraint tableName="pedidos"
                             columnNames="uuid"
                             constraintName="uk_pedidos_uuid"/>
        <createIndex tableName="pedidos" indexName="idx_pedidos_uuid">
            <column name="uuid"/>
        </createIndex>
    </changeSet>

    <!-- ========= respostas.uuid ========= -->

    <changeSet id="2025-09-05-uuid-04-add-col-respostas" author="voloide">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="respostas"/>
        </preConditions>
        <addColumn tableName="respostas">
            <column name="uuid" type="VARCHAR(36)"/>
        </addColumn>
    </changeSet>


    <changeSet id="2025-09-05-uuid-06-constraints-respostas" author="voloide">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="respostas" columnName="uuid"/>
        </preConditions>
        <addNotNullConstraint tableName="respostas"
                              columnName="uuid"
                              columnDataType="VARCHAR(36)"/>
        <addUniqueConstraint tableName="respostas"
                             columnNames="uuid"
                             constraintName="uk_respostas_uuid"/>
        <createIndex tableName="respostas" indexName="idx_respostas_uuid">
            <column name="uuid"/>
        </createIndex>
    </changeSet>

    <changeSet id="create-client-table" author="jnmabjaia">
        <createTable tableName="clients">
            <!-- BaseEntity fields -->
            <column name="ID" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="UUID" type="VARCHAR(50)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="CREATED_BY" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="CREATED_AT" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="UPDATED_BY" type="VARCHAR(50)"/>
            <column name="UPDATED_AT" type="DATETIME"/>
            <column name="LIFE_CYCLE_STATUS" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>

            <!-- Client specific fields -->
            <column name="US_CODE" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="CLIENT_ID" type="VARCHAR(100)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="CLIENT_SECRET" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="PUBLIC_KEY" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="SALT" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

</databaseChangeLog>