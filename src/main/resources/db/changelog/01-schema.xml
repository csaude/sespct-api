<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">
    <!-- Criação da tabela SETTINGS baseada em BaseEntity + Setting -->
    <changeSet id="001-create-settings" author="voloide">
        <!-- Se já existir, não recria -->
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="settings"/>
            </not>
        </preConditions>

        <!-- Para MySQL/MariaDB: engine + charset -->
        <createTable tableName="settings" >

            <!-- BaseEntity -->
            <column name="ID" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_settings"/>
            </column>

            <column name="UUID" type="VARCHAR(50)">
                <constraints nullable="false" unique="true" uniqueConstraintName="uk_settings_uuid"/>
            </column>

            <column name="CREATED_BY" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>

            <column name="CREATED_AT" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>

            <column name="UPDATED_BY" type="VARCHAR(50)"/>

            <column name="UPDATED_AT" type="TIMESTAMP"/>

            <column name="LIFE_CYCLE_STATUS" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>

            <!-- Campos específicos de Setting -->
            <column name="DESIGNATION" type="VARCHAR(150)">
                <constraints nullable="false"/>
            </column>

            <!-- ACEITA TEXTOS MUITO LONGOS -->
            <column name="SETTING_VALUE" type="LONGTEXT">
                <constraints nullable="false"/>
            </column>

            <column name="SETTING_TYPE" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>

            <column name="ENABLED" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>

            <!-- descrição pode ser grande; TEXT é suficiente -->
            <column name="DESCRIPTION" type="TEXT">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Unicidade por DESIGNATION (cada chave de configuração é única) -->
        <addUniqueConstraint tableName="settings"
                             columnNames="DESIGNATION"
                             constraintName="uk_settings_designation"/>

        <!-- Índices úteis -->
        <createIndex tableName="settings" indexName="idx_settings_designation">
            <column name="DESIGNATION"/>
        </createIndex>

        <createIndex tableName="settings" indexName="idx_settings_enabled">
            <column name="ENABLED"/>
        </createIndex>

        <createIndex tableName="settings" indexName="idx_settings_created_at">
            <column name="CREATED_AT"/>
        </createIndex>
    </changeSet>

    <changeSet id="2-create-pedidos" author="Joao Nuno Mabjaia">
        <createTable tableName="pedidos">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="pedido_id_ct" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="facility_code" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="payload" type="LONGTEXT">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="processed_at" type="DATETIME"/>
            <column name="error_msg" type="TEXT"/>
            <column name="created_by" type="varchar(50)">
                <constraints nullable="false"/>
            </column>

            <column name="created_at" type="timestamp">
                <constraints nullable="false"/>
            </column>

            <column name="updated_by" type="varchar(50)"/>

            <column name="updated_at" type="timestamp"/>

            <column name="life_cycle_status" type="varchar(100)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <!-- Tabela respostas -->
    <changeSet id="3-create-respostas" author="Joao Nuno Mabjaia">
        <createTable tableName="respostas">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="resposta_id_ct" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="pedido_id_ct" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="facility_code" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="payload" type="LONGTEXT">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="processed_at" type="DATETIME"/>
            <column name="error_msg" type="TEXT"/>
            <column name="created_by" type="varchar(50)">
                <constraints nullable="false"/>
            </column>

            <column name="created_at" type="timestamp">
                <constraints nullable="false"/>
            </column>

            <column name="updated_by" type="varchar(50)"/>

            <column name="updated_at" type="timestamp"/>

            <column name="life_cycle_status" type="varchar(100)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="create-client-table" author="jnmabjaia">
        <createTable tableName="clients">
            <!-- BaseEntity fields -->
            <column name="ID" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="UUID" type="VARCHAR(50)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="CREATED_BY" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="CREATED_AT" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="UPDATED_BY" type="VARCHAR(50)"/>
            <column name="UPDATED_AT" type="DATETIME"/>
            <column name="LIFE_CYCLE_STATUS" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>

            <!-- Client specific fields -->
            <column name="US_CODE" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="CLIENT_ID" type="VARCHAR(100)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="CLIENT_SECRET" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="PUBLIC_KEY" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="SALT" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

</databaseChangeLog>